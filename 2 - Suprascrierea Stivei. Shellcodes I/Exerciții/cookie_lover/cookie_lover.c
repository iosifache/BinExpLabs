#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <fcntl.h>
#include <unistd.h>
#include <time.h>

#define FLAG_FILE "flag.txt"
#define WELCOME_STRING "-----------------------------COOKIE LOVERS CLUB-------------------------------------------\nWelcome to our club! Please demostrate that you are a cookie lover by inserting a message:\n"
#define STACK_SMASHED_STRING "You are not a cookie lover. You smashed one!\n"
#define GOODBYE_STRING "Yeah,  you are only a regular cookie lover.\nBut we don't want this kind of people in our club. Sorry..\n"

unsigned int stack_cookie;

void send_fail() {
    printf(GOODBYE_STRING);
    fflush(stdout);
}

void send_flag() {
    char member_text[] = {
        0x58, 0x6e, 0x74, 0x21, 0x65, 0x64, 0x6c, 0x6e, 0x6f, 0x72, 0x75, 0x60,
        0x75, 0x64, 0x21, 0x74, 0x72, 0x21, 0x75, 0x69, 0x60, 0x75, 0x21, 0x78,
        0x6e, 0x74, 0x21, 0x60, 0x73, 0x64, 0x21, 0x60, 0x21, 0x75, 0x73, 0x74,
        0x64, 0x21, 0x62, 0x6e, 0x6e, 0x6a, 0x68, 0x64, 0x21, 0x6d, 0x6e, 0x77,
        0x64, 0x73, 0x2f, 0x21, 0x58, 0x6e, 0x74, 0x21, 0x65, 0x68, 0x65, 0x26,
        0x75, 0x21, 0x64, 0x77, 0x64, 0x6f, 0x21, 0x72, 0x6c, 0x60, 0x72, 0x69,
        0x21, 0x6e, 0x6f, 0x64, 0x20, 0x0b, 0x49, 0x64, 0x73, 0x64, 0x21, 0x68,
        0x72, 0x21, 0x60, 0x21, 0x73, 0x64, 0x76, 0x60, 0x73, 0x65, 0x21, 0x67,
        0x6e, 0x73, 0x21, 0x78, 0x6e, 0x74, 0x3b, 0x21, 0x52, 0x48, 0x7a, 0x40,
        0x5e, 0x43, 0x40, 0x4d, 0x40, 0x4f, 0x42, 0x44, 0x45, 0x5e, 0x45, 0x48,
        0x44, 0x55, 0x5e, 0x48, 0x52, 0x5e, 0x40, 0x5e, 0x42, 0x4e, 0x4e, 0x4a,
        0x48, 0x44, 0x5e, 0x48, 0x4f, 0x5e, 0x44, 0x40, 0x42, 0x49, 0x5e, 0x49,
        0x40, 0x4f, 0x45, 0x7c
    };
    char key = 0x01;
    int i;

    for (i = 0; i < sizeof(member_text); i++) {
        member_text[i] = member_text[i] ^ key;
    }

    printf("%s", member_text);
    fflush(stdout);
}

int create_cookie() {
    int random_value,  now;

    now = time(0);
    srand(now);
    random_value = rand();
    stack_cookie = random_value % now;

    return stack_cookie;
}

int check_cookie_smashing(int cookie) {
    if (cookie != stack_cookie) {
        printf(STACK_SMASHED_STRING);

        exit(1);
    }

    return 1;
}

int serve_new_member() {
    char buffer[28];
    void (*called)(void) = send_fail;
    int cookie = create_cookie();

    printf(WELCOME_STRING);
    fflush(stdout);

    fread(buffer, 64, 1,  stdin);
    if (check_cookie_smashing(cookie) > 0) {
        called();
    }

    return 0;
}

int main(int argc,  char *argv[]) {
    serve_new_member();
}